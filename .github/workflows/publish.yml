name: Publish to GitHub Packages

on:
    release:
        types: [published]
    push:
        branches:
            - 'feature/**'

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: '10.0.x'

            - name: Restore
              run: dotnet restore

            - name: Build
              run: dotnet build --configuration Release --no-restore

            - name: Test
              run: dotnet test --configuration Release --no-build

            - name: Set Package Version
              id: version
              run: |
                  if [ "${{ github.event_name }}" == "release" ]; then
                    echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
                  else
                    LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
                    LATEST_VERSION=${LATEST_TAG#v}
                    echo "version=${LATEST_VERSION}-dev.${{ github.sha }}" >> $GITHUB_OUTPUT
                  fi

            - name: Pack
              run: dotnet pack --configuration Release --no-build --output .nupkg -p:PackageVersion=${{ steps.version.outputs.version }}

            - name: Upload NuGet Package
              uses: actions/upload-artifact@v4
              with:
                  name: nuget-package
                  path: **/.nupkg/*.nupkg
                  if-no-files-found: error

    publish:
        needs: build
        runs-on: ubuntu-latest
        permissions:
            packages: write
            contents: read
        steps:
            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: '10.0.x'

            - name: Download NuGet Package
              uses: actions/download-artifact@v4
              with:
                  name: nuget-package
                  path: .nupkg

            - name: Push to GitHub Packages
              run: dotnet nuget push .nupkg/*.nupkg --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate
